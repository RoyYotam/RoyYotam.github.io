<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Royxigul</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f2f2f2;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    h1 {
      margin-bottom: 1rem;
    }
    .public-board {
      display: grid;
      grid-template-columns: repeat(3, auto);
      gap: 10px;
    }
    .local-board {
      display: grid;
      grid-template-columns: repeat(3, 30px);
      gap: 2px;
      background-color: #ddd;
      padding: 5px;
      border: 2px solid #999;
      position: relative;
      width: fit-content;
      height: fit-content;
    }
    .cell {
      width: 30px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #fff;
      cursor: pointer;
      font-weight: bold;
    }
    .cell.disabled {
      background-color: #eee;
      cursor: not-allowed;
    }
    .highlight {
      border: 2px solid red;
    }
    .winner-cell {
      background-color: #b2fab4 !important;
    }
    #reset-btn {
      position: absolute;
      top: 20px;
      right: 60px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }
    #download-replay {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }
    .winner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 48px;
      font-weight: bold;
      color: #444;
      pointer-events: none;
    }
    .global-winner-board {
      box-shadow: 0 0 10px 4px #7ed957;
      position: relative;
    }
  </style>
</head>
<body>
  <h1>Royxigul
    <button id="reset-btn" title="Reset Game">ðŸ”„</button>
    <button id="download-replay" title="Download Replay">ðŸ’¾</button>
  </h1>
  <div id="board" class="public-board"></div>
  <p id="status"></p>
  <script>
    const boardContainer = document.getElementById('board');
    const statusText = document.getElementById('status');
    const resetBtn = document.getElementById('reset-btn');
    const downloadBtn = document.getElementById('download-replay');

    let currentPlayer, nextBoardIndex, publicBoard, globalWin, moveHistory;

    function checkWin(cells) {
      const wins = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6],
      ];
      for (const combo of wins) {
        const [a, b, c] = combo;
        if (cells[a] && cells[a] === cells[b] && cells[a] === cells[c]) {
          return { winner: cells[a], line: combo };
        }
      }
      return null;
    }

    function createGame() {
      currentPlayer = 'X';
      nextBoardIndex = null;
      globalWin = null;
      moveHistory = [];
      publicBoard = Array.from({ length: 9 }, (_, i) => ({
        index: i,
        cells: Array(9).fill(null),
        element: null,
        winner: null,
        winLine: [],
      }));
      renderBoard();
      statusText.textContent = `Player ${currentPlayer}'s turn`;
    }

    function renderBoard() {
      boardContainer.innerHTML = '';
      publicBoard.forEach((board, bIndex) => {
        const boardEl = document.createElement('div');
        boardEl.className = 'local-board';
        if (nextBoardIndex === null || nextBoardIndex === bIndex) {
          boardEl.classList.add('highlight');
        }
        if (globalWin && globalWin.line.includes(bIndex)) {
          boardEl.classList.add('global-winner-board');
        }

        board.cells.forEach((cell, cIndex) => {
          const cellEl = document.createElement('div');
          cellEl.className = 'cell';
          if (cell) {
            cellEl.textContent = cell;
            cellEl.classList.add('disabled');
          } else if (
            (nextBoardIndex === null || nextBoardIndex === bIndex) &&
            !board.winner
          ) {
            cellEl.onclick = () => handleMove(bIndex, cIndex);
          } else {
            cellEl.classList.add('disabled');
          }

          if (board.winLine.includes(cIndex)) {
            cellEl.classList.add('winner-cell');
          }

          boardEl.appendChild(cellEl);
        });

        if (board.winner) {
          const overlay = document.createElement('div');
          overlay.className = 'winner-overlay';
          overlay.textContent = board.winner;
          boardEl.appendChild(overlay);
        }

        board.element = boardEl;
        boardContainer.appendChild(boardEl);
      });
    }

    function handleMove(bIndex, cIndex) {
      const board = publicBoard[bIndex];
      if (board.cells[cIndex] || board.winner) return;

      board.cells[cIndex] = currentPlayer;
      moveHistory.push({ player: currentPlayer, board: bIndex, cell: cIndex });

      const winResult = checkWin(board.cells);
      if (winResult) {
        board.winner = winResult.winner;
        board.winLine = winResult.line;
        board.element.style.backgroundColor = winResult.winner === 'X' ? '#cfc' : '#ccf';
      }

      const globalCheck = checkWin(publicBoard.map(b => b.winner));
      if (globalCheck) {
        globalWin = globalCheck;
        statusText.textContent = `Player ${globalWin.winner} wins the game!`;
        disableAll();
        return;
      }

      nextBoardIndex = publicBoard[cIndex].winner || publicBoard[cIndex].cells.every(c => c) ? null : cIndex;
      currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
      statusText.textContent = `Player ${currentPlayer}'s turn`;
      renderBoard();
    }

    function disableAll() {
      publicBoard.forEach(board => board.cells = board.cells.map(c => c || '-'));
      renderBoard();
    }

    function downloadReplay() {
      const blob = new Blob([
        JSON.stringify({ moves: moveHistory }, null, 2)
      ], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'royxigul-replay.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    resetBtn.onclick = createGame;
    downloadBtn.onclick = downloadReplay;

    createGame();
  </script>
</body>
</html>
